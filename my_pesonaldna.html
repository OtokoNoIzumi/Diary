<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Izumi.Qu's Persona</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* ========= Color System (Base) ========= */
            /* B：象牙纸/书页（非黑色系） */
            --paper: #F3EBDD;
            --paper-2: #EEE3D1;
            --paper-3: #E7D8C2;
            --ink: #201B14;
            --ink-dim: rgba(32, 27, 20, 0.70);
            --ink-faint: rgba(32, 27, 20, 0.46);
            --bg-dark: var(--paper);
            --bg-a: var(--paper);
            --bg-b: var(--paper-2);
            --panel-bg: rgba(243, 235, 221, 0.86);
            --panel-bg-2: rgba(238, 227, 209, 0.82);
            --text-main: var(--ink);
            --text-dim: var(--ink-dim);
            --text-faint: var(--ink-faint);
            --ghost: rgba(32, 27, 20, 0.12);
            --border: 1px solid rgba(32, 27, 20, 0.10);

            /* ========= Theme Accent (Dynamic) ========= */
            --accent: #5D7F96; /* 默认：2007（晨雾蓝灰，带色相） */
            --accent-glow: rgba(93, 127, 150, 0.10);
            --accent-weak: rgba(93, 127, 150, 0.14);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* 字体设置：极客感 */
        body {
            background:
                radial-gradient(1200px 800px at 18% 8%, rgba(93, 127, 150, 0.10), rgba(255,255,255,0) 55%),
                radial-gradient(900px 700px at 88% 22%, rgba(154, 98, 69, 0.08), rgba(255,255,255,0) 52%),
                linear-gradient(180deg, var(--bg-a), var(--bg-b));
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 背景层：可替换为Midjourney图片 */
        #art-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center;
            opacity: 0.10;
            transition: opacity 1s ease, background-image 1s ease;
            filter: blur(18px) saturate(0.6) brightness(1.15) contrast(0.92); /* 纸面上更像底纹而不是夜景 */
        }

        /* 扫描线特效 */
        /* 扫描线特效（赛博风）：已禁用 */
        #scanline {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(32,27,20,0.06) 50%, rgba(32,27,20,0.06));
            background-size: 100% 4px;
            z-index: -1;
            pointer-events: none;
            display: none;
        }

        /* 顶部导航 */
        header {
            padding: calc(12px + var(--safe-top)) 18px 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(243, 235, 221, 0.82);
            backdrop-filter: blur(10px);
            border-bottom: var(--border);
            z-index: 10;
            gap: 14px;
        }

        .system-id {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            font-size: 0.9rem;
            color: var(--accent);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .brand-title {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            font-size: 0.95rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent);
            white-space: nowrap;
        }

        .brand-sub {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            font-size: 0.72rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-faint);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 42vw;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            min-width: 180px;
        }

        .compare-indicator {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            font-size: 0.78rem;
            color: var(--text-faint);
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pill-toggle {
            display: flex;
            gap: 6px;
            background: rgba(32, 27, 20, 0.06);
            padding: 4px;
            border-radius: 999px;
            border: var(--border);
        }

        .pill-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 7px 10px;
            cursor: pointer;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 700;
            letter-spacing: 1px;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 44px; /* touch friendly */
        }
        .pill-btn.active {
            background: var(--accent);
            color: var(--paper);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .header-nav-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(32,27,20,0.12);
            background: rgba(243,235,221,0.75);
            backdrop-filter: blur(10px);
            color: rgba(32,27,20,0.88);
            cursor: pointer;
            font-size: 18px;
            line-height: 40px;
            text-align: center;
            box-shadow: 0 10px 24px rgba(32,27,20,0.18);
        }
        .header-nav-btn:active { transform: scale(0.98); }

        /* 模式切换器 */
        .view-toggle {
            display: flex;
            gap: 20px;
            background: rgba(32, 27, 20, 0.04);
            padding: 5px;
            border-radius: 20px;
            border: var(--border);
        }
        .mode-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background: var(--accent);
            color: var(--paper);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* 桌面端：让 Analysis 类目更像“清单” */
        body[data-mode="analysis"] .analysis-nav .year-btn {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            letter-spacing: 0.2px;
        }
        body[data-mode="analysis"] .analysis-nav .year-btn.active {
            background: linear-gradient(90deg, rgba(0,242,255,0.12), transparent);
        }

        /* 主布局 */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 350px 1fr; /* 左侧控制/叙事，右侧图表 */
            gap: 20px;
            padding: 30px;
            overflow: hidden;
        }

        /* 左侧面板 */
        .control-panel {
            background: var(--panel-bg);
            border: var(--border);
            border-radius: 12px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            overflow-y: auto;
            transition: all 0.5s ease;
        }

        /* 导航按钮组 (Timeline) */
        .timeline-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }
        .year-btn {
            text-align: left;
            background: transparent;
            border: 1px solid rgba(32,27,20,0.12);
            padding: 12px 20px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            border-radius: 2px;
            letter-spacing: 0.5px;
            border-left: 3px solid transparent;
        }
        .year-btn:hover { background: rgba(32,27,20,0.05); }
        .year-btn.active {
            color: var(--text-main);
            border-left: 3px solid var(--accent);
            background: linear-gradient(90deg, var(--accent-weak), transparent);
        }

        /* 分析按钮组 (Analysis) */
        .analysis-nav {
            display: none; /* 默认隐藏 */
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        /* 叙事文本 */
        .narrative-box {
            margin-top: auto;
        }
        .role-title {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 10px;
            color: var(--text-main);
        }
        .role-subtitle {
            font-size: 0.9rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 20px;
            display: block;
        }
        .story-text {
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(32, 27, 20, 0.82);
            text-align: justify;
        }
        .insight-tag {
            margin-top: 20px;
            padding: 10px;
            border: 1px dashed var(--text-dim);
            font-size: 0.85rem;
            color: var(--text-dim);
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
        }

        .report-link {
            display: inline-block;
            margin-top: 14px;
            padding: 8px 14px;
            border: 1px solid var(--accent);
            border-radius: 6px;
            font-size: 0.82rem;
            color: var(--accent);
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            text-decoration: none;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }
        .report-link:hover {
            background: var(--accent);
            color: var(--paper);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        /* 作者信息（展签） */
        .author-card {
            margin-top: 18px;
            padding: 12px 14px;
            border: var(--border);
            border-radius: 12px;
            background: var(--panel-bg-2);
        }
        .author-title {
            font-size: 0.78rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-faint);
            margin-bottom: 6px;
        }
        .author-name {
            font-size: 0.98rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 8px;
        }
        .author-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        .author-links a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid rgba(32,27,20,0.18);
            padding-bottom: 1px;
        }
        .author-links a:hover {
            border-bottom-color: var(--accent);
        }
        .author-dot {
            color: var(--text-faint);
        }
        .author-meta {
            font-size: 0.78rem;
            color: var(--text-faint);
        }

        /* 右侧图表区 */
        .visual-panel {
            position: relative;
            background: var(--panel-bg);
            border: var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .visual-stack {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 14px;
            align-items: stretch;
        }

        .chart-shell {
            position: relative;
            flex: 1;
            min-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            max-height: 85vh;
            max-width: 100%;
        }

        /* 双端量表指示器 */
        .dual-scale-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 14px;
        }

        .dual-scale {
            border: var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            background: rgba(243,235,221,0.55);
        }

        .dual-scale-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 8px;
        }

        .dual-scale-name {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            font-size: 0.78rem;
            color: rgba(32,27,20,0.78);
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .dual-scale-value {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            font-size: 0.78rem;
            color: rgba(32,27,20,0.58);
        }

        .dual-scale-track {
            height: 8px;
            border-radius: 999px;
            background: rgba(32,27,20,0.08);
            position: relative;
            overflow: hidden;
        }

        .dual-scale-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, rgba(32,27,20,0.10), rgba(32,27,20,0.18));
        }

        .dual-scale-thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
            border: 1px solid rgba(32,27,20,0.22);
        }

        .dual-scale-ghost {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            height: 18px;
            width: 0px;
            border-left: 3px dashed rgba(32,27,20,0.28);
            filter: drop-shadow(0 0 8px rgba(32,27,20,0.10));
            pointer-events: none;
            display: none;
        }

        .dual-scale-ends {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.72rem;
            color: rgba(32,27,20,0.46);
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            letter-spacing: 1px;
        }

        /* 切换动画 */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ===============  Analysis 布局（桌面） =============== */
        body[data-mode="analysis"] main {
            grid-template-columns: 350px 1fr;
        }
        body[data-mode="analysis"] .control-panel {
            padding-bottom: 16px;
        }
        body[data-mode="analysis"] #nav-timeline {
            display: none !important;
        }
        body[data-mode="analysis"] #nav-analysis {
            display: flex !important;
        }
        body[data-mode="analysis"] #dual-scale-panel {
            display: none;
        }
        body[data-mode="analysis"] .visual-panel {
            align-items: stretch;
            justify-content: flex-start;
        }
        body[data-mode="analysis"] .chart-shell {
            min-height: 320px;
        }
        body[data-mode="analysis"] #narrative-container {
            margin-top: 0;
        }

        /* Trends 模式：Compare/Ghost 彻底隐藏（含移动端抽屉），避免样式/时序导致露出 */
        body[data-mode="analysis"] .header-controls [aria-label="compare toggle"],
        body[data-mode="analysis"] #compare-indicator,
        body[data-mode="analysis"] .bottom-sheet [aria-label="compare toggle in sheet"],
        body[data-mode="analysis"] #compare-indicator-sheet {
            display: none !important;
        }

        /* ===============  Mobile 响应式：主屏上图下叙事 + 导航抽屉 =============== */
        .mobile-fab {
            position: fixed;
            right: 14px;
            bottom: calc(14px + var(--safe-bottom));
            z-index: 30;
            width: 52px;
            height: 52px;
            border-radius: 999px;
            border: 1px solid rgba(32,27,20,0.12);
            background: rgba(243,235,221,0.88);
            backdrop-filter: blur(10px);
            color: var(--text-main);
            cursor: pointer;
            display: none;
            box-shadow: 0 10px 24px rgba(32,27,20,0.18);
        }
        .mobile-fab:active { transform: scale(0.98); }

        .sheet-overlay {
            position: fixed;
            inset: 0;
            z-index: 40;
            background: rgba(32,27,20,0.25);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
        }
        .sheet-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
            background: rgba(243,235,221,0.96);
            border-top: 1px solid rgba(32,27,20,0.10);
            backdrop-filter: blur(18px);
            transform: translateY(105%);
            transition: transform 0.22s ease;
            padding: 12px 14px calc(14px + var(--safe-bottom)) 14px;
        }
        .bottom-sheet.open {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 44px;
            height: 5px;
            border-radius: 999px;
            background: rgba(32,27,20,0.14);
            margin: 4px auto 10px auto;
        }

        .sheet-title {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            color: rgba(32,27,20,0.62);
            letter-spacing: 1px;
            text-transform: uppercase;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Bottom sheet：纵向列表，最多露出约 5 个条目，多余滚动 */
        .sheet-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: min(310px, 52vh);
            overflow-y: auto;
            padding-right: 2px;
        }
        .sheet-list::-webkit-scrollbar { width: 8px; }
        .sheet-list::-webkit-scrollbar-thumb { background: rgba(32,27,20,0.14); border-radius: 999px; }

        .sheet-item {
            width: 100%;
            border: 1px solid rgba(32,27,20,0.12);
            background: rgba(32,27,20,0.03);
            color: rgba(32,27,20,0.86);
            border-radius: 12px;
            padding: 12px 14px;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .sheet-item small {
            color: rgba(32,27,20,0.50);
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        .sheet-item.active {
            border-color: rgba(32,27,20,0.18);
            background: var(--accent);
            color: var(--paper);
            box-shadow: 0 0 18px var(--accent-glow);
        }
        .sheet-item.active small { color: rgba(243,235,221,0.90); }

        @media (max-width: 820px) {
            header {
                padding-left: 14px;
                padding-right: 14px;
                gap: 10px;
            }
            .brand-title { display: none; }
            .brand-sub { max-width: 46vw; }
            .header-meta {
                display: none;
            }
            .view-toggle {
                gap: 8px;
                padding: 4px;
            }
            .mode-btn {
                padding: 7px 12px;
                font-size: 0.82rem;
            }
            /* 手机端：头部不占主屏（语言/GHOST 放在抽屉内），但不要影响抽屉里的 pill-toggle */
            .header-controls .pill-toggle {
                display: none;
            }
            .bottom-sheet .pill-toggle {
                display: flex !important; /* 确保抽屉内可见中英文/GHOST入口 */
            }
            .header-nav-btn {
                display: inline-block;
            }
            main {
                grid-template-columns: 1fr;
                padding: 14px;
                gap: 14px;
                overflow: auto;
            }
            /* 修复：analysis 模式在移动端仍被两列布局锁定，导致右侧空一列 */
            body[data-mode="analysis"] main {
                grid-template-columns: 1fr;
            }
            .control-panel {
                display: none;
            }
            .visual-panel {
                padding: 14px;
                overflow: auto; /* 允许内容超出时滚动，避免底部量表被裁切 */
            }
            .visual-stack {
                height: auto; /* 解除 height:100% 导致的裁切 */
            }
            .chart-shell {
                flex: 0 0 auto; /* 避免图表强占剩余高度挤压下面内容 */
            }
            .mobile-fab {
                display: none; /* 改用右上角按钮打开抽屉 */
            }
            .chart-shell {
                min-height: 36vh; /* 给下方叙事 + 双端量表留出更多可视空间 */
            }
            /* Timeline 手机端：双端量表改为纵向堆叠，避免两列挤压导致显示不完整 */
            .dual-scale-panel {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-top: 10px;
            }
            .dual-scale {
                padding: 10px;
            }
            .dual-scale-track {
                height: 7px;
            }
            .dual-scale-thumb {
                width: 11px;
                height: 11px;
            }
            .dual-scale-ghost {
                height: 16px;
            }
            .dual-scale-name {
                white-space: normal; /* 允许断行 */
                line-height: 1.2;
                overflow-wrap: anywhere;
            }
            #narrative-container .role-title {
                font-size: 1.55rem;
            }
            #narrative-container .story-text {
                font-size: 0.98rem;
            }
            #narrative-container .insight-tag {
                font-size: 0.82rem;
            }
            canvas {
                max-height: none;
                width: 100% !important;
            }
        }

    </style>
</head>
<body>

    <div id="art-layer"></div>
    <div id="scanline"></div>

    <header>
        <div class="header-left">
            <div class="view-toggle" aria-label="mode toggle">
                <button class="mode-btn active" id="btn-mode-timeline" onclick="switchMode('timeline')">TIMELINE</button>
                <button class="mode-btn" id="btn-mode-analysis" onclick="switchMode('analysis')">TRENDS</button>
            </div>
            <div class="brand" aria-label="site title">
                <div class="brand-title" id="brand-title">Izumi.Qu's Persona</div>
                <div class="brand-sub" id="brand-sub">人当然会成长改变，这是一份记录</div>
            </div>
        </div>
        <div class="header-right">
            <button class="header-nav-btn" id="header-nav-btn" onclick="openMobileSheet()" aria-label="open navigation">≡</button>
            <div class="header-controls">
                <div class="pill-toggle" aria-label="language toggle">
                    <button class="pill-btn" id="btn-lang-en" onclick="setLanguage('en')">EN</button>
                    <button class="pill-btn" id="btn-lang-zh" onclick="setLanguage('zh')">中文</button>
                </div>
                <div class="pill-toggle" aria-label="compare toggle">
                    <button class="pill-btn active" id="btn-ghost" onclick="toggleGhost()">GHOST</button>
                </div>
            </div>
            <div class="header-meta">
                <div class="compare-indicator" id="compare-indicator">COMPARE: —</div>
            </div>
        </div>
    </header>

    <main>
        <!-- 左侧：控制与叙事 -->
        <div class="control-panel">

            <!-- 模式 A: 时间轴导航 -->
            <div class="timeline-nav" id="nav-timeline">
                <!-- JS 生成 -->
            </div>

            <!-- 模式 B: 维度分析导航 -->
            <div class="analysis-nav" id="nav-analysis">
                <!-- JS 生成 -->
            </div>

            <!-- 叙事区域 -->
            <div id="narrative-slot-left"></div>
            <div class="narrative-box fade-in" id="narrative-container">
                <h1 class="role-title" id="display-title">Initializing...</h1>
                <span class="role-subtitle" id="display-sub">System Ready</span>
                <p class="story-text" id="display-text">Waiting for user input...</p>
                <div class="insight-tag" id="display-insight">LOG: 0000</div>
                <a class="report-link" id="report-link" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">查看原始报告</a>
            </div>

            <!-- 作者信息：展签式署名卡 -->
            <div class="author-card" id="author-card" aria-label="author info">
                <div class="author-title" id="author-title">作者信息</div>
                <div class="author-name">Izumi.屈源</div>
                <div class="author-links">
                    <a href="https://otokonoizumi.github.io" target="_blank" rel="noopener noreferrer">GitHub</a>
                    <span class="author-dot">·</span>
                    <a href="https://space.bilibili.com/82205" target="_blank" rel="noopener noreferrer">Bilibili</a>
                    <span class="author-dot">·</span>
                    <a href="https://x.com/Fisheam" target="_blank" rel="noopener noreferrer">X</a>
                </div>
                <div class="author-meta" id="author-meta">© 2025 Izumi.屈源</div>
            </div>
        </div>

        <!-- 右侧：可视化图表 -->
        <div class="visual-panel">
            <div class="visual-stack">
                <div class="chart-shell">
                    <canvas id="mainChart"></canvas>
                </div>
                <div id="narrative-slot-right"></div>
                <div class="dual-scale-panel" id="dual-scale-panel">
                    <div class="dual-scale" id="dual-earthy">
                        <div class="dual-scale-header">
                            <div class="dual-scale-name" id="dual-earthy-name">Earthy/Imaginative</div>
                            <div class="dual-scale-value" id="dual-earthy-value">—</div>
                        </div>
                        <div class="dual-scale-track">
                            <div class="dual-scale-fill"></div>
                            <div class="dual-scale-thumb" id="dual-earthy-thumb" style="left:50%"></div>
                            <div class="dual-scale-ghost" id="dual-earthy-ghost" style="left:50%"></div>
                        </div>
                        <div class="dual-scale-ends">
                            <span id="dual-earthy-left">Imaginative</span>
                            <span id="dual-earthy-right">Earthy</span>
                        </div>
                    </div>
                    <div class="dual-scale" id="dual-aesthetic">
                        <div class="dual-scale-header">
                            <div class="dual-scale-name" id="dual-aesthetic-name">Aesthetic/Functional</div>
                            <div class="dual-scale-value" id="dual-aesthetic-value">—</div>
                        </div>
                        <div class="dual-scale-track">
                            <div class="dual-scale-fill"></div>
                            <div class="dual-scale-thumb" id="dual-aesthetic-thumb" style="left:50%"></div>
                            <div class="dual-scale-ghost" id="dual-aesthetic-ghost" style="left:50%"></div>
                        </div>
                        <div class="dual-scale-ends">
                            <span id="dual-aesthetic-left">Functional</span>
                            <span id="dual-aesthetic-right">Aesthetic</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button class="mobile-fab" id="mobile-fab" onclick="openMobileSheet()" aria-label="open navigation">≡</button>
    <div class="sheet-overlay" id="sheet-overlay" onclick="closeMobileSheet()"></div>
    <div class="bottom-sheet" id="bottom-sheet" role="dialog" aria-modal="true" aria-label="navigation sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-title">
            <span id="sheet-title-text">NAV</span>
            <span id="sheet-close" style="cursor:pointer" onclick="closeMobileSheet()">CLOSE</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap">
            <div class="pill-toggle" aria-label="language toggle in sheet">
                <button class="pill-btn" id="btn-lang-en-sheet" onclick="setLanguage('en')">EN</button>
                <button class="pill-btn" id="btn-lang-zh-sheet" onclick="setLanguage('zh')">中文</button>
            </div>
            <div class="pill-toggle" aria-label="compare toggle in sheet">
                <button class="pill-btn active" id="btn-ghost-sheet" onclick="toggleGhost()">GHOST</button>
            </div>
            <div class="compare-indicator" id="compare-indicator-sheet" style="margin-left:auto">COMPARE: —</div>
        </div>
        <div class="sheet-list" id="sheet-list"></div>
    </div>

    <script>
        // ==========================================
        // 核心数据库 (13维度)
        // ==========================================
        const fullDatabase = {
            // 维度顺序：严格对齐原报告展示顺序
            traitOrder: [
                "Confidence",
                "Openness",
                "Extroversion",
                "Empathy",
                "Trust in others",
                "Agency",
                "Perseverance",
                "Interdependence",
                "Spontaneity",
                "Attention to style",
                "Authoritarianism",
                "Earthy/Imaginative",
                "Aesthetic/Functional"
            ],

            radarTraitOrder: [
                "Confidence",
                "Openness",
                "Extroversion",
                "Empathy",
                "Trust in others",
                "Agency",
                "Perseverance",
                "Interdependence",
                "Spontaneity",
                "Attention to style",
                "Authoritarianism"
            ],

            // 1. 原始快照数据
            snapshots: [
                {
                    date: "2007-10-03",
                    year: 2007,
                    role: "Benevolent Leader",
                    narrative: "这是记录的序章。大三的你，拥有一种未经世事打磨的柔软。高达 94% 的信任度和开放的同理心，显示出你对世界有着天然的善意预期。与其说是一个“领导者”，不如说是一个愿意照顾所有人的“守护者”。那时的你，内心通透，但也因为缺乏保护色，容易在复杂的社会规则面前感到迷茫。",
                    insight: "阶段特征：[纯真与迷茫]。拥有极高的道德直觉，但尚未掌握掌控命运的工具。",
                    themeColor: "#5D7F96", // Air / Mist (Blue Grey, higher chroma)
                    bgImage: "", // 可以在这里填入 prompt 生成的图片 url
                    reportUrl: "https://personalitydna.com/report/WakavTRRIWdYRYQ-OO-CACCA-6fd0/",
                    stats: {
                        "Confidence": 44,
                        "Openness": 52,
                        "Extroversion": 72,
                        "Empathy": 52,
                        "Trust in others": 94,
                        "Agency": 38,
                        "Perseverance": 34,
                        "Interdependence": 34,
                        "Spontaneity": 16,
                        "Attention to style": 44,
                        "Authoritarianism": 58,
                        "Earthy/Imaginative": 48,
                        "Aesthetic/Functional": 34
                    }
                },
                {
                    date: "2008-10-07",
                    year: 2008,
                    role: "Benevolent Analyst",
                    narrative: "面对毕业的岔路口，你做出了第一次关键的自我修正。为了在不确定的未来中站稳脚跟，你强迫自己收起了对他人的依赖（Interdependence 骤降至 10%），并将发散的好奇心收束为聚焦的逻辑。这是一种生存本能的觉醒：你意识到，想要保护内心的善意，首先必须穿上理性的铠甲。",
                    insight: "阶段特征：[断舍离]。为了生存，你主动切断了情感的软肋，换取了行动的硬度。",
                    themeColor: "#9A6245", // Iron / Rust (Vintage Brown, richer)
                    reportUrl: "https://personalitydna.com/report/eEohpkaFHjbbaYb-MO-AACAD-8921/",
                    stats: {
                        "Confidence": 60,
                        "Openness": 8,
                        "Extroversion": 80,
                        "Empathy": 66,
                        "Trust in others": 82,
                        "Agency": 72,
                        "Perseverance": 52,
                        "Interdependence": 10,
                        "Spontaneity": 14,
                        "Attention to style": 70,
                        "Authoritarianism": 54,
                        "Earthy/Imaginative": 54,
                        "Aesthetic/Functional": 52
                    }
                },
                {
                    date: "2011-05-20",
                    year: 2011,
                    role: "Animated Idealist",
                    narrative: "深圳快节奏的职场生活，将你推向了极致的实用主义。毅力（Perseverance）被拉升至 94%，你变成了一个能够解决任何难题的行动派。此时的你，不再迷信权威（Authoritarianism 降至 28%），只相信逻辑与结果。虽然被称为“理想主义者”，但你的理想不再是空谈，而是必须通过一个个具体的项目落地来实现。",
                    insight: "阶段特征：[野蛮生长]。情感让位于效率，你用绝对的执行力在城市中确立了自己的坐标。",
                    themeColor: "#C09A4A", // Gold / Brass (Muted Gold, richer)
                    reportUrl: "https://personalitydna.com/report/oOnYgfvHMaOQRYW-EK-DACAA-9ae1/",
                    stats: {
                        "Confidence": 80,
                        "Openness": 28,
                        "Extroversion": 78,
                        "Empathy": 48,
                        "Trust in others": 64,
                        "Agency": 62,
                        "Perseverance": 94,
                        "Interdependence": 14,
                        "Spontaneity": 24,
                        "Attention to style": 52,
                        "Authoritarianism": 28,
                        "Earthy/Imaginative": 68,
                        "Aesthetic/Functional": 34
                    }
                },
                {
                    date: "2022-09-13",
                    year: 2022,
                    role: "Animated Analyst",
                    narrative: "作为制作人，你不仅构建了游戏世界，也重新构建了自己。风格关注度（Style）飙升至 84%，这标志着你开始掌控对自我的定义权——无论是着装的表达，还是职场的身份。为了维持这套复杂的双重生活运转，你几乎牺牲了所有的随机性（Spontaneity 降至 2%）。这是一种精密的平衡术，你是自己生活的总设计师。",
                    insight: "阶段特征：[自我重塑]。通过极度的自律与规划，你在现实世界中硬生生开辟出了做自己的空间。",
                    themeColor: "#4C57B1", // Velvet / Ink (Slate Blue, less grey)
                    reportUrl: "https://personalitydna.com/report/kSkUgqvMAqKmSfQ-MK-DABAD-2c07/",
                    stats: {
                        "Confidence": 72,
                        "Openness": 36,
                        "Extroversion": 72,
                        "Empathy": 40,
                        "Trust in others": 64,
                        "Agency": 84,
                        "Perseverance": 94,
                        "Interdependence": 24,
                        "Spontaneity": 2,
                        "Attention to style": 84,
                        "Authoritarianism": 20,
                        "Earthy/Imaginative": 76,
                        "Aesthetic/Functional": 36
                    }
                },
                {
                    date: "2025-12-25",
                    year: 2025,
                    role: "Animated Leader",
                    narrative: "至此，你达到了一种近乎‘透明’的独立状态。Agency（掌控感）达到满值，Perseverance 96%，意味着你对命运进行了定义，并在一方天地里拥有了绝对的主导权。最深刻的变化在于 Interdependence 降至 2%——你不再向外索求情感支撑，不仅是因为强大，更是因为习惯了独处。这种极致的独立，反而让你能以一种更平和、更信任（Trust 88%）的姿态去俯瞰周遭。",
                    insight: "阶段特征：[极致的自主]。你终于不再需要铠甲，因为你本身已经足够坚硬与完整。",
                    themeColor: "#4C9FD0", // Platinum / Ice (Steel Ice Blue)
                    reportUrl: "https://personalitydna.com/report/oSoOsywAAsQlIeX-OK-DBBDE-6dbf/",
                    stats: {
                        "Confidence": 80,
                        "Openness": 36,
                        "Extroversion": 80,
                        "Empathy": 28,
                        "Trust in others": 88,
                        "Agency": 100,
                        "Perseverance": 96,
                        "Interdependence": 2,
                        "Spontaneity": 2,
                        "Attention to style": 88,
                        "Authoritarianism": 32,
                        "Earthy/Imaginative": 74,
                        "Aesthetic/Functional": 16
                    }
                }
            ],

            // 2. 维度叙事包 (用于趋势分析)
            analysisGroups: [
                {
                    key: "control_loop",
                    label: "秩序的辩证 (Dialectic of Order)",
                    metrics: ["Agency", "Spontaneity"],
                    colors: ["#4C9FD0", "#9A6245"],
                    title: "在确定性与可能性之间",
                    story: "这一组看的是“秩序”如何被建造出来。Agency 的持续抬升，是你一步步把生活从不确定里拽出来的过程；而 Spontaneity 的下沉，则像你为安全与可控付出的代价。它不是对错，更像一种长期选择：当人生需要承载更复杂的结构时，意外会先被清理出场。",
                    insight: "思考：当一切尽在掌握时，你还愿意为“意外”留下多少空间？"
                },
                {
                    key: "execution_engine",
                    label: "意志的引擎 (Engine of Will)",
                    metrics: ["Perseverance", "Openness"],
                    colors: ["#C09A4A", "#4C57B1"],
                    title: "深挖与广度的抉择",
                    story: "Perseverance 记录的是你如何把一条路走到尽头；Openness 则记录你对世界保持入口的方式。它们并不冲突，但在关键阶段，你更像一个带着问题的求解者：把好奇心收束成方法，把分散的可能性压缩成可兑现的路径。",
                    insight: "思考：当你选择了深度，广度会以什么方式被补偿？"
                },
                {
                    key: "social_port",
                    label: "人群与信任 (Crowd & Trust)",
                    metrics: ["Extroversion", "Trust in others"],
                    // 同一面板内需要“跨色相”区分：蓝（在场） vs 黄铜（信任/握手）
                    colors: ["#4C9FD0", "#C09A4A"],
                    title: "你一直在场，但不一定交出自己",
                    story: "Extroversion 表示你是否常在现场、是否愿意与人发生互动；Trust in others 表示你对他人的默认善意与合作预期。两条线合起来，会把“热闹”与“亲近”区分开：你可以在人群里高效运转，也可以在同一时刻保留内在的安静与边界。",
                    insight: "提示：信任提高时，边界与规则反而更重要——它们让信任可持续。"
                },
                {
                    key: "social_bond",
                    label: "连接的边界 (Boundary of Connection)",
                    metrics: ["Empathy", "Interdependence"],
                    colors: ["#4C57B1", "#9A6245"],
                    title: "亲密、依赖与自我完整",
                    story: "Empathy 是你对他人情绪的感应能力；Interdependence 是你在关系里允许互相支撑的程度。当它们一起走低时，往往不是“冷漠”，而是把脆弱与修复更多交给结构、流程和自我消化。它会让你更稳定，也会让温度需要被更主动地经营。",
                    insight: "思考：你更习惯“被理解”，还是更习惯“自我完成”？"
                },
                {
                    key: "presentation_layer",
                    label: "存在的审美 (Aesthetics of Being)",
                    metrics: ["Attention to style", "Aesthetic/Functional"],
                    colors: ["#4C57B1", "#C09A4A"],
                    title: "夺回“我是谁”的表达权",
                    story: "Attention to style 不是虚荣，更像你对“被看见的方式”的主权意识；Aesthetic/Functional 则像你在表达与效率之间的取舍倾向。它们一起看，会更接近“你如何用外在去承载内在”：身份、作品、职业，都在这里相遇。",
                    insight: "提示：当风格投入很高时，最好让它服务于清晰的目标：表达、效率、或身份的稳定。"
                },
                {
                    key: "authority_attitude",
                    label: "规则与自我 (Rules & Self)",
                    metrics: ["Authoritarianism"],
                    colors: ["#5D7F96"],
                    title: "你更信逻辑，而不是名分",
                    story: "Authoritarianism 不是“服从/反叛”的道德题，更像你对等级秩序的天然亲和度。越低，越倾向第一性原理与自我判断；越高，越倾向借助规则与共识降低摩擦。它会直接影响你如何管理团队、如何建立可复制的协作方式。",
                    insight: "提示：当你追求规模化时，写在纸面上的规则比口头协调更可靠。"
                },
                {
                    key: "grounding_axis",
                    label: "想象的落点 (Grounding Axis)",
                    metrics: ["Earthy/Imaginative"],
                    colors: ["#9A6245"],
                    title: "你把抽象带到哪里去",
                    story: "Earthy/Imaginative 更像思考的落点：你更信模型，还是更信现场？更先搭结构，还是更先找触感？它决定你如何做判断、如何创作，也决定你如何把一个想法变成可以交付的现实。",
                    insight: "提示：把它与 Openness / Perseverance 一起看，往往能解释你的创作与决策风格。"
                },
                {
                    key: "confidence",
                    label: "承担的底盘 (Confidence)",
                    metrics: ["Confidence"],
                    colors: ["#C09A4A"],
                    title: "敢不敢承担结果",
                    story: "Confidence 影响你做决定的速度，也影响你在争议里的稳定性。它和 Agency 不同：Agency 更像“能不能控制局面”，Confidence 更像“敢不敢承担后果”。当你越往前走，越需要把自信与校验机制绑定在一起：数据、同伴评审、复盘。",
                    insight: "提示：自信不是不要怀疑，而是知道该在哪里怀疑。"
                }
            ]
        };

        // ==========================================
        // 系统逻辑
        // ==========================================

        let chartInstance = null;
        let currentMode = 'timeline';
        let primaryIndex = 0;
        let compareIndex = null;
        let showGhost = true;
        let currentAnalysisIndex = 0;
        let currentLang = 'en';

        function init() {
            setupLanguage(getInitialLanguage());
            renderNavButtons();
            switchMode('timeline'); // 默认进入 Timeline 模式
        }

        // 切换模式逻辑
        function switchMode(mode) {
            currentMode = mode;
            document.body.setAttribute('data-mode', mode);

            // 按钮样式
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="switchMode('${mode}')"]`).classList.add('active');

            // 导航栏切换
            document.getElementById('nav-timeline').style.display = mode === 'timeline' ? 'flex' : 'none';
            document.getElementById('nav-analysis').style.display = mode === 'analysis' ? 'flex' : 'none';

            updateCompareUiVisibility();
            applyResponsiveLayout();
            if (mode === 'timeline') {
                loadYear(primaryIndex, { updateCompare: false });
            } else {
                // 切换到 Trends 时隐藏报告链接
                const reportLinkEl = document.getElementById('report-link');
                if (reportLinkEl) reportLinkEl.style.display = 'none';
                loadAnalysis(currentAnalysisIndex); // 记住上次分析组
            }

            updateMobileSheetContent();
        }

        // 渲染侧边栏按钮
        function renderNavButtons() {
            const tlContainer = document.getElementById('nav-timeline');
            tlContainer.innerHTML = '';
            fullDatabase.snapshots.forEach((snap, idx) => {
                const btn = document.createElement('button');
                btn.className = 'year-btn';
                btn.innerHTML = `${snap.year} <span style="font-size:0.8em; opacity:0.6">${snap.role}</span>`;
                btn.onclick = () => loadYear(idx, { updateCompare: true });
                tlContainer.appendChild(btn);
            });

            const anContainer = document.getElementById('nav-analysis');
            anContainer.innerHTML = '';
            fullDatabase.analysisGroups.forEach((group, idx) => {
                const btn = document.createElement('button');
                btn.className = 'year-btn'; // 复用样式
                btn.innerText = group.label;
                btn.onclick = () => loadAnalysis(idx);
                anContainer.appendChild(btn);
            });

            updateMobileSheetContent();
        }

        // ========================
        // 模式 A: Timeline 渲染
        // ========================
        function loadYear(index, opts = { updateCompare: true }) {
            if (typeof index !== 'number' || index < 0 || index >= fullDatabase.snapshots.length) return;
            if (opts.updateCompare && index !== primaryIndex) {
                compareIndex = primaryIndex;
            }
            primaryIndex = index;
            const data = fullDatabase.snapshots[index];
            const prevData = (showGhost && compareIndex !== null && compareIndex !== index) ? fullDatabase.snapshots[compareIndex] : null;

            // 1. 更新 UI 文本
            const dateText = data.date ? data.date : String(data.year);
            updateNarrative(
                data.role,
                `DATE: ${dateText}`,
                data.narrative,
                data.insight
            );

            // 1.5. 更新原始报告链接
            const reportLinkEl = document.getElementById('report-link');
            if (reportLinkEl && data.reportUrl) {
                reportLinkEl.href = data.reportUrl;
                reportLinkEl.style.display = 'inline-block';
            } else if (reportLinkEl) {
                reportLinkEl.style.display = 'none';
            }

            // 2. 高亮按钮
            updateNavHighlight('nav-timeline', index);

            // 3. 更新 CSS 变量颜色
            applyAccentTheme(data.themeColor);

            // 4. 顶部对比提示
            updateCompareIndicator();

            // 5. 绘制雷达图 (带幽灵残影：lastclick)
            const ctx = document.getElementById('mainChart').getContext('2d');

            if (chartInstance) chartInstance.destroy();

            const labels = fullDatabase.radarTraitOrder.map(k => getTraitLabel(k));
            const currentValues = fullDatabase.radarTraitOrder.map(k => toScore(data.stats[k]));

            const datasets = [{
                label: `${data.year} Current`,
                data: currentValues,
                backgroundColor: hexToRgba(data.themeColor, 0.10),
                borderColor: data.themeColor,
                borderWidth: 2,
                pointBackgroundColor: '#F3EBDD',
                pointRadius: 4
            }];

            if (prevData) {
                datasets.push({
                    label: `${prevData.year} Compare`,
                    data: fullDatabase.radarTraitOrder.map(k => toScore(prevData.stats[k])),
                    backgroundColor: 'transparent',
                    // 用“对比年份的主题色 + 半透明 + 虚线”，在纸面背景上也清晰可辨
                    borderColor: hexToRgba(prevData.themeColor, 0.70),
                    borderWidth: 2,
                    borderDash: [6, 6], // 虚线
                    pointRadius: 0
                });
            }

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(32,27,20,0.10)' },
                            grid: { color: 'rgba(32,27,20,0.10)' },
                            pointLabels: {
                                color: 'rgba(32,27,20,0.88)',
                                font: { size: 11, family: 'Helvetica Neue' }
                            },
                            ticks: { display: false, max: 100, min: 0 }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: 'rgba(32,27,20,0.72)', font: { family: 'Helvetica Neue' } }
                        }
                    },
                    animation: { duration: 1000 }
                }
            });

            // 6. 更新双端量表指示器
            updateDualScales(data, prevData);

            // 7. 更新移动端 chips 高亮
            updateMobileActiveChip();
        }

        // ========================
        // 模式 B: Analysis 渲染
        // ========================
        function loadAnalysis(index) {
            if (typeof index !== 'number' || index < 0 || index >= fullDatabase.analysisGroups.length) return;
            currentAnalysisIndex = index;
            const group = fullDatabase.analysisGroups[index];

            // 1. 更新 UI 文本
            updateNarrative(
                group.title,
                "DIMENSIONAL TREND ANALYSIS",
                group.story,
                group.insight
            );

            // 2. 高亮按钮
            updateNavHighlight('nav-analysis', index);

            // 3. 准备折线图数据
            const years = fullDatabase.snapshots.map(s => s.year);
            const pointBg = getComputedStyle(document.documentElement).getPropertyValue('--panel-bg-2').trim() || 'rgba(243,235,221,0.92)';
            const pointStyles = ['circle', 'rectRounded', 'triangle', 'rect', 'star'];
            const datasets = group.metrics.map((metric, i) => {
                const c = group.colors[i % group.colors.length];
                return {
                    label: getTraitLabel(metric),
                    data: fullDatabase.snapshots.map(s => toScore(s.stats[metric])),
                    borderColor: c,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    tension: 0.3, // 曲线平滑度
                    pointRadius: 4,
                    pointStyle: pointStyles[i % pointStyles.length],
                    pointBackgroundColor: pointBg,
                    pointBorderColor: c,
                    pointBorderWidth: 2
                };
            });

            // 4. 绘制折线图
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(32,27,20,0.08)' },
                            ticks: { color: 'rgba(32,27,20,0.62)' }
                        },
                        y: {
                            min: 0, max: 100,
                            grid: { color: 'rgba(32,27,20,0.08)' },
                            ticks: { color: 'rgba(32,27,20,0.62)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'rgba(32,27,20,0.72)' } },
                        tooltip: {
                            backgroundColor: 'rgba(243,235,221,0.96)',
                            titleColor: 'rgba(32,27,20,0.92)',
                            bodyColor: 'rgba(32,27,20,0.92)',
                            titleFont: { size: 14 },
                            bodyFont: { size: 14 },
                            padding: 10,
                            displayColors: true
                        }
                    }
                }
            });

            updateCompareIndicator();
            updateMobileActiveChip();
        }

        // 辅助函数：更新文本
        function updateNarrative(title, sub, text, insight) {
            const box = document.getElementById('narrative-container');
            // 简单的淡入淡出动画
            box.style.opacity = 0;
            box.style.transform = 'translateY(10px)';

            setTimeout(() => {
                document.getElementById('display-title').innerText = title;
                document.getElementById('display-sub').innerText = sub;
                document.getElementById('display-text').innerText = text;
                document.getElementById('display-insight').innerText = insight;

                box.style.opacity = 1;
                box.style.transform = 'translateY(0)';
            }, 300);
        }

        // 辅助函数：导航高亮
        function updateNavHighlight(containerId, index) {
            const container = document.getElementById(containerId);
            Array.from(container.children).forEach((btn, idx) => {
                if (idx === index) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        // ========================
        // 语言与标签
        // ========================
        const I18N = {
            en: {
                modeTimeline: "TIMELINE",
                modeTrends: "TRENDS",
                sheetNavTimeline: "YEARS",
                sheetNavAnalysis: "CATEGORIES",
                sheetClose: "CLOSE",
                compare: "COMPARE",
                ghost: "GHOST"
            },
            zh: {
                modeTimeline: "演化",
                modeTrends: "趋势",
                sheetNavTimeline: "年份",
                sheetNavAnalysis: "类目",
                sheetClose: "关闭",
                compare: "对比",
                ghost: "残影"
            }
        };

        const TRAIT_LABEL_ZH = {
            "Confidence": "自信",
            "Openness": "开放性",
            "Extroversion": "外向性",
            "Empathy": "同理心",
            "Trust in others": "信任他人",
            "Agency": "掌控感",
            "Perseverance": "毅力",
            "Interdependence": "相互依赖",
            "Spontaneity": "随性",
            "Attention to style": "风格关注",
            "Authoritarianism": "权威主义",
            "Earthy/Imaginative": "务实/想象",
            "Aesthetic/Functional": "审美/功能"
        };

        function getInitialLanguage() {
            const saved = localStorage.getItem('pdna_lang');
            if (saved === 'zh' || saved === 'en') return saved;
            const nav = (navigator.language || '').toLowerCase();
            return nav.startsWith('zh') ? 'zh' : 'en';
        }

        function setupLanguage(lang) {
            currentLang = (lang === 'zh') ? 'zh' : 'en';
            localStorage.setItem('pdna_lang', currentLang);
            document.documentElement.setAttribute('lang', currentLang === 'zh' ? 'zh-CN' : 'en');

            document.getElementById('btn-lang-en').classList.toggle('active', currentLang === 'en');
            document.getElementById('btn-lang-zh').classList.toggle('active', currentLang === 'zh');
            document.getElementById('btn-lang-en-sheet').classList.toggle('active', currentLang === 'en');
            document.getElementById('btn-lang-zh-sheet').classList.toggle('active', currentLang === 'zh');

            document.getElementById('btn-mode-timeline').innerText = I18N[currentLang].modeTimeline;
            document.getElementById('btn-mode-analysis').innerText = I18N[currentLang].modeTrends;
            document.getElementById('sheet-close').innerText = I18N[currentLang].sheetClose;

            updateAuthorBlock();
            updateCompareIndicator();
            updateMobileSheetContent();

            // 重新渲染当前图表标签
            if (currentMode === 'timeline') {
                loadYear(primaryIndex, { updateCompare: false });
            } else {
                loadAnalysis(currentAnalysisIndex);
            }
        }

        function updateAuthorBlock() {
            const t = document.getElementById('author-title');
            const meta = document.getElementById('author-meta');
            if (t) t.innerText = (currentLang === 'zh') ? '作者信息' : 'Author';
            if (meta) meta.innerText = '© 2025 Izumi.屈源';
        }

        function setLanguage(lang) {
            setupLanguage(lang);
        }

        function getTraitLabel(traitKey) {
            if (currentLang === 'zh') return TRAIT_LABEL_ZH[traitKey] || traitKey;
            return traitKey;
        }

        // ========================
        // 对比/残影
        // ========================
        function toggleGhost() {
            showGhost = !showGhost;
            document.getElementById('btn-ghost').classList.toggle('active', showGhost);
            document.getElementById('btn-ghost-sheet').classList.toggle('active', showGhost);
            updateCompareIndicator();
            if (currentMode === 'timeline') loadYear(primaryIndex, { updateCompare: false });
        }

        function updateCompareIndicator() {
            const el = document.getElementById('compare-indicator');
            const elSheet = document.getElementById('compare-indicator-sheet');
            const label = I18N[currentLang].compare;

            if (currentMode === 'timeline' && showGhost && compareIndex !== null && compareIndex !== primaryIndex) {
                const a = fullDatabase.snapshots[compareIndex]?.year ?? '—';
                const b = fullDatabase.snapshots[primaryIndex]?.year ?? '—';
                const text = `${label}: ${a} → ${b}`;
                el.innerText = text;
                elSheet.innerText = text;
            } else if (currentMode === 'analysis') {
                const text = `${label}: —`;
                el.innerText = text;
                elSheet.innerText = text;
            } else {
                const text = `${label}: —`;
                el.innerText = text;
                elSheet.innerText = text;
            }
        }

        // ========================
        // 双端量表指示器
        // ========================
        function updateDualScales(snapshot, compareSnapshot) {
            const earthy = toScore(snapshot.stats["Earthy/Imaginative"]);
            const aesth = toScore(snapshot.stats["Aesthetic/Functional"]);
            const hasCompare = !!compareSnapshot;
            const earthyCmp = hasCompare ? toScore(compareSnapshot.stats["Earthy/Imaginative"]) : null;
            const aesthCmp = hasCompare ? toScore(compareSnapshot.stats["Aesthetic/Functional"]) : null;
            const cmpLabel = currentLang === 'zh' ? '对比' : 'cmp';

            // Earthy/Imaginative：数值越大越偏 Earthy（按原报告右端）
            document.getElementById('dual-earthy-thumb').style.left = `${earthy}%`;
            document.getElementById('dual-earthy-value').innerText = hasCompare ? `${earthy}% · ${cmpLabel} ${earthyCmp}%` : `${earthy}%`;
            // 用 wbr 提升移动端断行质量
            document.getElementById('dual-earthy-name').innerHTML = currentLang === 'zh' ? '务实/想象' : 'Earthy/<wbr>Imaginative';
            document.getElementById('dual-earthy-left').innerText = currentLang === 'zh' ? '想象' : 'Imaginative';
            document.getElementById('dual-earthy-right').innerText = currentLang === 'zh' ? '务实' : 'Earthy';
            const earthyGhost = document.getElementById('dual-earthy-ghost');
            if (hasCompare) {
                earthyGhost.style.display = 'block';
                earthyGhost.style.left = `${earthyCmp}%`;
                earthyGhost.style.borderLeftColor = hexToRgba(compareSnapshot.themeColor, 0.70);
            } else {
                earthyGhost.style.display = 'none';
            }

            // Aesthetic/Functional：原报告表现为 Functional -> Aesthetic，这里按数值越大越偏 Aesthetic（右端）
            document.getElementById('dual-aesthetic-thumb').style.left = `${aesth}%`;
            document.getElementById('dual-aesthetic-value').innerText = hasCompare ? `${aesth}% · ${cmpLabel} ${aesthCmp}%` : `${aesth}%`;
            document.getElementById('dual-aesthetic-name').innerHTML = currentLang === 'zh' ? '审美/功能' : 'Aesthetic/<wbr>Functional';
            document.getElementById('dual-aesthetic-left').innerText = currentLang === 'zh' ? '功能' : 'Functional';
            document.getElementById('dual-aesthetic-right').innerText = currentLang === 'zh' ? '审美' : 'Aesthetic';
            const aesthGhost = document.getElementById('dual-aesthetic-ghost');
            if (hasCompare) {
                aesthGhost.style.display = 'block';
                aesthGhost.style.left = `${aesthCmp}%`;
                aesthGhost.style.borderLeftColor = hexToRgba(compareSnapshot.themeColor, 0.70);
            } else {
                aesthGhost.style.display = 'none';
            }
        }

        // ========================
        // DOM 结构：叙事容器挂载位置
        // ========================
        function mountNarrative(where) {
            const narrative = document.getElementById('narrative-container');
            const leftSlot = document.getElementById('narrative-slot-left');
            const rightSlot = document.getElementById('narrative-slot-right');
            if (!narrative || !leftSlot || !rightSlot) return;

            if (where === 'right') {
                rightSlot.appendChild(narrative);
            } else {
                leftSlot.appendChild(narrative);
            }
        }

        function isMobile() {
            return window.matchMedia && window.matchMedia('(max-width: 820px)').matches;
        }

        function applyResponsiveLayout() {
            // 手机端：永远把叙事放在图表下（右侧 slot），保证“上图下叙事”完整一屏
            if (isMobile()) {
                mountNarrative('right');
                return;
            }
            // 桌面端：timeline 叙事在左；analysis 叙事在图下
            if (currentMode === 'timeline') mountNarrative('left');
            else mountNarrative('right');
        }

        // ========================
        // Mobile Bottom Sheet 导航
        // ========================
        function openMobileSheet() {
            updateMobileSheetContent();
            document.getElementById('sheet-overlay').classList.add('open');
            document.getElementById('bottom-sheet').classList.add('open');
        }

        function closeMobileSheet() {
            document.getElementById('sheet-overlay').classList.remove('open');
            document.getElementById('bottom-sheet').classList.remove('open');
        }

        function updateMobileSheetContent() {
            const titleEl = document.getElementById('sheet-title-text');
            const listEl = document.getElementById('sheet-list');
            if (!titleEl || !listEl) return;

            // 同步 Compare/Ghost 的可见性（Trends 不显示）
            updateCompareUiVisibility();

            listEl.innerHTML = '';
            if (currentMode === 'timeline') {
                titleEl.innerText = I18N[currentLang].sheetNavTimeline;
                fullDatabase.snapshots.forEach((snap, idx) => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'sheet-item';
                    item.innerHTML = `<span>${snap.year}</span><small>${snap.role}</small>`;
                    item.onclick = () => {
                        closeMobileSheet();
                        loadYear(idx, { updateCompare: true });
                    };
                    listEl.appendChild(item);
                });
            } else {
                titleEl.innerText = I18N[currentLang].sheetNavAnalysis;
                fullDatabase.analysisGroups.forEach((group, idx) => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'sheet-item';
                    item.innerHTML = `<span>${group.label}</span><small>${String(group.metrics?.length ?? 0)} metrics</small>`;
                    item.onclick = () => {
                        closeMobileSheet();
                        loadAnalysis(idx);
                    };
                    listEl.appendChild(item);
                });
            }
            updateMobileActiveChip();
        }

        function updateCompareUiVisibility() {
            const isTimeline = currentMode === 'timeline';

            // Header: GHOST + 对比文本（Trends 隐藏）
            const headerGhostToggle = document.querySelector('.header-controls [aria-label="compare toggle"]');
            const headerCompareText = document.getElementById('compare-indicator');
            if (headerGhostToggle) headerGhostToggle.style.display = isTimeline ? '' : 'none';
            if (headerCompareText) headerCompareText.style.display = isTimeline ? '' : 'none';

            // Sheet: GHOST + 对比文本（Trends 隐藏）
            const sheetGhostToggle = document.querySelector('.bottom-sheet [aria-label="compare toggle in sheet"]');
            const sheetCompareText = document.getElementById('compare-indicator-sheet');
            if (sheetGhostToggle) sheetGhostToggle.style.display = isTimeline ? '' : 'none';
            if (sheetCompareText) sheetCompareText.style.display = isTimeline ? '' : 'none';
        }

        function updateMobileActiveChip() {
            const listEl = document.getElementById('sheet-list');
            if (!listEl) return;
            const items = Array.from(listEl.children);
            items.forEach((el, i) => {
                if (currentMode === 'timeline') el.classList.toggle('active', i === primaryIndex);
                else el.classList.toggle('active', i === currentAnalysisIndex);
            });
        }

        // ========================
        // 工具函数
        // ========================
        function toScore(v) {
            const n = Number(v);
            if (Number.isFinite(n)) {
                if (n < 0) return 0;
                if (n > 100) return 100;
                return n;
            }
            return 0;
        }

        // ========= Color helpers =========
        function hexToRgba(hex, alpha) {
            const h = String(hex).replace('#', '').trim();
            if (!/^[0-9a-fA-F]{6}$/.test(h)) return `rgba(78,197,216,${alpha})`;
            const r = parseInt(h.slice(0,2), 16);
            const g = parseInt(h.slice(2,4), 16);
            const b = parseInt(h.slice(4,6), 16);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function applyAccentTheme(hex) {
            document.documentElement.style.setProperty('--accent', hex);
            document.documentElement.style.setProperty('--accent-glow', hexToRgba(hex, 0.10));
            document.documentElement.style.setProperty('--accent-weak', hexToRgba(hex, 0.14));
        }

        // 启动
        window.onload = () => {
            init();
            applyResponsiveLayout();
            window.addEventListener('resize', () => {
                applyResponsiveLayout();
            }, { passive: true });
        };

    </script>
</body>
</html>